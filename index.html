<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Giả Lập Thị Trường Chứng Khoán</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <script type="module">
        /* ============================================================
           BẢN KHÔNG DÙNG FIREBASE – SAVE LOCALSTORAGE 100%
        ============================================================ */

        const API_KEY = "AIzaSyASdIzbW2wRzRYqMo4U7WneMo1eFoK5s2E";
        const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${API_KEY}`;

        const STOCK_SYMBOL = "FPT_GEMINI";

        const INITIAL_CASH = 100000;
        const INITIAL_PRICE = 100;
        const TICK_INTERVAL_MS = 1500;
        const AI_UPDATE_INTERVAL_TICKS = 15;

        const VOLATILITY_MAGNITUDE = 0.01;
        const AI_BIAS_WEIGHT = 0.7;
        const MEAN_REVERSION_RATE = 0.0005;

        const INTEREST_RATE_PER_TICK = 0.0001;

        let gameTick = 0;
        let gameLoopInterval = null;

        // Trạng thái game
        let gameState = {
            cash: INITIAL_CASH,
            portfolio: {},
            priceHistory: [{ price: INITIAL_PRICE, tick: 0 }],
            stockPrice: INITIAL_PRICE,
            marketSentiment: 0,
            latestNews: "Thị trường đang ổn định.",
            loanAmount: 0,
            lastSave: Date.now()
        };

        /* ============================================================
           LOCAL STORAGE
        ============================================================ */
        const saveGame = () => {
            localStorage.setItem("stock_game_state_ai", JSON.stringify(gameState));
        };

        const loadGame = () => {
            const saved = localStorage.getItem("stock_game_state_ai");
            if (saved) {
                try {
                    gameState = { ...gameState, ...JSON.parse(saved) };
                    console.log("Loaded state:", gameState);
                } catch {
                    console.warn("Lỗi parse save, reset.");
                }
            }
        };

        loadGame();

        /* ============================================================
           TIỆN ÍCH
        ============================================================ */
        const formatCurrency = (v) =>
            new Intl.NumberFormat("vi-VN", { style: "currency", currency: "VND", minimumFractionDigits: 0 }).format(v);

        const calculateTotalValue = () => {
            const holdings = gameState.portfolio[STOCK_SYMBOL] || { quantity: 0 };
            return gameState.cash + holdings.quantity * gameState.stockPrice - gameState.loanAmount;
        };

        /* ============================================================
           GEMINI AI
        ============================================================ */
        const getGeminiSentiment = async () => {
            const payload = {
                contents: [{ parts: [{ text: "Sinh tin và hệ số chứng khoán." }] }],
                systemInstruction: {
                    parts: [{
                        text: `Tạo news và adjustmentFactor [-0.1, 0.1] cho mã FPT_GEMINI.`
                    }]
                },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            adjustmentFactor: { type: "NUMBER" },
                            newsHeadline: { type: "STRING" }
                        }
                    }
                }
            };

            try {
                const res = await fetch(GEMINI_API_URL, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });

                const data = await res.json();
                const raw = data.candidates?.[0]?.content?.parts?.[0]?.text;

                if (raw) {
                    const { adjustmentFactor, newsHeadline } = JSON.parse(raw);
                    gameState.marketSentiment = Math.max(-0.1, Math.min(0.1, adjustmentFactor));
                    gameState.latestNews = newsHeadline;
                }

            } catch {
                gameState.marketSentiment = (Math.random() * 0.2 - 0.1);
                gameState.latestNews = "Lỗi AI – thị trường dao động ngẫu nhiên.";
            }
        };

        /* ============================================================
           MÔ PHỎNG GIÁ
        ============================================================ */
        const updatePrice = () => {
            gameTick++;

            const cur = gameState.stockPrice;

            let change = (Math.random() - 0.5) * 2 * VOLATILITY_MAGNITUDE;
            change += (INITIAL_PRICE - cur) * MEAN_REVERSION_RATE;
            change += gameState.marketSentiment * AI_BIAS_WEIGHT;

            let newPrice = cur + change * cur;
            newPrice = Math.max(1, newPrice);
            gameState.stockPrice = newPrice;

            if (gameState.loanAmount > 0) {
                gameState.cash -= gameState.loanAmount * INTEREST_RATE_PER_TICK;
            }

            gameState.priceHistory.push({ price: newPrice, tick: gameTick });
            if (gameState.priceHistory.length > 50) {
                gameState.priceHistory.shift();
            }

            if (gameTick % AI_UPDATE_INTERVAL_TICKS === 0) getGeminiSentiment();
        };

        /* ============================================================
           GIAO DỊCH
        ============================================================ */
        window.buyStock = () => {
            const qty = parseInt(document.getElementById("qty-input").value || "0");
            if (qty <= 0) return;

            const cost = qty * gameState.stockPrice;
            if (gameState.cash < cost) return alert("Không đủ tiền!");

            gameState.cash -= cost;
            if (!gameState.portfolio[STOCK_SYMBOL]) gameState.portfolio[STOCK_SYMBOL] = { quantity: 0 };
            gameState.portfolio[STOCK_SYMBOL].quantity += qty;

            saveGame();
            renderDashboard();
        };

        window.sellStock = () => {
            const qty = parseInt(document.getElementById("qty-input").value || "0");
            if (qty <= 0) return;

            const holdings = gameState.portfolio[STOCK_SYMBOL]?.quantity || 0;
            if (qty > holdings) return alert("Không đủ cổ phiếu!");

            const money = qty * gameState.stockPrice;
            gameState.cash += money;
            gameState.portfolio[STOCK_SYMBOL].quantity -= qty;

            saveGame();
            renderDashboard();
        };

        /* ============================================================
           RENDER giao diện
        ============================================================ */
        const renderDashboard = () => {
            document.getElementById("price").textContent = gameState.stockPrice.toFixed(2);
            document.getElementById("cash").textContent = formatCurrency(gameState.cash);
            document.getElementById("loan").textContent = formatCurrency(gameState.loanAmount);
            document.getElementById("news-headline").textContent = gameState.latestNews;

            const holdings = gameState.portfolio[STOCK_SYMBOL]?.quantity || 0;
            document.getElementById("holding").textContent = holdings;

            document.getElementById("total-value").textContent =
                formatCurrency(calculateTotalValue());
        };

        const startGameLoop = () => {
            if (gameLoopInterval) return;

            getGeminiSentiment();
            gameLoopInterval = setInterval(() => {
                updatePrice();
                renderDashboard();
                if (gameTick % 10 === 0) saveGame();
            }, TICK_INTERVAL_MS);
        };

        window.onload = () => {
            renderDashboard();
            startGameLoop();
        };
    </script>
</head>

<body class="bg-gray-900 text-white p-6">
    <h1 class="text-2xl font-bold">Giả Lập Chứng Khoán – Bản Không Firebase</h1>

    <div class="mt-4">
        <p>Giá: <span id="price"></span></p>
        <p>Tiền mặt: <span id="cash"></span></p>
        <p>Cổ phiếu đang giữ: <span id="holding"></span></p>
        <p>Tổng giá trị: <span id="total-value"></span></p>
        <p>Nợ: <span id="loan"></span></p>
        <p class="text-yellow-400 mt-4">Tin mới: <span id="news-headline"></span></p>
    </div>

    <div class="mt-4">
        <input id="qty-input" class="text-black p-2" type="number" placeholder="Số lượng">
        <button onclick="buyStock()" class="bg-green-600 px-4 py-2 m-2">Mua</button>
        <button onclick="sellStock()" class="bg-red-600 px-4 py-2">Bán</button>
    </div>

</body>
</html>
